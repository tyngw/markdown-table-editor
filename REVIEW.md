# リファクタリング後の機能差分レビュー

## 概要
大規模なリファクタリングによって発生した以下の機能差分について調査を実施しました：
1. 行・列のドラッグドロップによる位置の移動ができない
2. ウィンドウ幅によって列の幅が変わってしまう問題

## 調査結果

### 1. 行・列のドラッグドロップ機能の問題

#### 原因分析
リファクタリング前後のコード比較により、以下の問題が特定されました：

**A. HTMLファイルの構造変更**
- **リファクタリング前**: `tableEditor.html.bak`では、ドラッグドロップ機能がHTMLファイル内のインラインJavaScriptで実装されていた
- **リファクタリング後**: `tableEditor.html`では、モジュラー化されたJavaScriptファイルの動的読み込み方式に変更

**B. ドラッグドロップ実装の分離**
- **リファクタリング前**: 単一ファイル内で`startRowDrag`、`startColumnDrag`などの関数が直接定義
- **リファクタリング後**: `DragDropManager`モジュール（`webview/js/drag-drop.js`）として分離

**C. イベントハンドラーの呼び出し方法の変更**
- **リファクタリング前**: 直接関数呼び出し（例：`onmousedown="startRowDrag(${rowIndex}, event)"`）
- **リファクタリング後**: モジュール経由の呼び出し（例：`onmousedown="TableEditor.callModule('DragDropManager', 'startRowDrag', ${rowIndex}, event)"`）

#### 具体的な問題点

1. **draggable属性の設定タイミング**
   - `DragDropManager.setupDragAndDrop()`で`draggable="true"`を設定しているが、テーブルの再レンダリング後に呼び出されていない可能性

2. **イベントハンドラーの重複定義**
   - `table-renderer.js`で`onmousedown`と`ondragstart`の両方が設定されているが、競合している可能性

3. **モジュール初期化の順序**
   - JavaScriptファイルの動的読み込み順序により、`DragDropManager`が適切に初期化される前にイベントが発生している可能性

### 2. ウィンドウ幅による列幅変更の問題

#### 原因分析

**A. CSSの列幅制御方式の変更**
- **リファクタリング前**: `min-width: 120px`の固定値
- **リファクタリング後**: JavaScriptによる動的な`min-width`、`max-width`、`width`の設定

**B. table-layoutの影響**
- 両バージョンで`table-layout: fixed`が設定されているが、動的な幅設定との相互作用で問題が発生

**C. ウィンドウリサイズハンドラーの実装**
- `ColumnResizeManager`でウィンドウリサイズ時の処理を実装しているが、期待通りに動作していない可能性

#### 具体的な問題点

1. **デフォルト列幅の管理**
   - リファクタリング前：CSS固定値（120px）
   - リファクタリング後：JavaScript変数（150px）での管理

2. **user-resizedクラスの条件**
   - `state.columnWidths[index] !== 150`の条件により、デフォルト幅が変更されたときの処理が不適切

3. **ウィンドウリサイズ時の幅復元**
   - `setupWindowResizeHandler`で幅を維持しようとしているが、ブラウザの自動調整と競合している可能性

## 推奨される修正方針

### 1. ドラッグドロップ機能の修正

1. **初期化順序の確保**
   - テーブルレンダリング後に`DragDropManager.setupDragAndDrop()`が確実に呼び出されるよう修正

2. **イベントハンドラーの整理**
   - `onmousedown`と`ondragstart`の役割を明確に分離
   - 重複するイベントハンドラーを統合

3. **draggable属性の管理**
   - テーブル再レンダリング時に`draggable="true"`が確実に設定されるよう修正

### 2. 列幅問題の修正

1. **CSS固定幅への回帰検討**
   - 動的幅管理の複雑さを避け、CSS固定値（min-width）への部分的回帰

2. **ウィンドウリサイズハンドラーの見直し**
   - ブラウザの自動調整を阻害しない方式への変更

3. **デフォルト幅の統一**
   - CSS（120px）とJavaScript（150px）のデフォルト値を統一

## 緊急度評価

- **ドラッグドロップ機能**: **高** - 基本機能が完全に動作しない
- **列幅問題**: **中** - 使用感に影響するが、機能自体は動作する

## 次のステップ

1. ドラッグドロップ機能の修正を優先実施
2. 列幅問題の修正は段階的に実施
3. 修正後の回帰テストの実施