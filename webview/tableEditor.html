<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline' vscode-resource: https:; style-src-elem 'self' vscode-resource: https:; script-src 'unsafe-inline' vscode-resource:;">
    <title>Markdown Table Editor</title>
    <script>
        // VSCodeæ‹¡å¼µã®webviewã§å¤–éƒ¨CSSã‚’å®‰å…¨ã«èª­ã¿è¾¼ã‚€ãŸã‚ã®vscode-resourceã‚¹ã‚­ãƒ¼ãƒã‚’ä½¿ã†
        // æ‹¡å¼µå´ã§ `webview.asWebviewUri` ã§CSSã®ãƒ‘ã‚¹ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹
        if (window.cssUri) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.cssUri;
            document.head.appendChild(link);
        }
        
        // Acquire VSCode API once at the global level
        let globalVscode = null;
        try {
            globalVscode = acquireVsCodeApi();
            window.vscode = globalVscode; // Make it available globally
            console.log('Global VSCode API acquired successfully');
        } catch (error) {
            console.warn('Failed to acquire VSCode API globally:', error);
        }
        
        // Load modular JavaScript files
        let scriptLoadQueue = [];
        let loadedScripts = 0;
        
        function loadNextScript() {
            if (window.scriptUris && Array.isArray(window.scriptUris)) {
                if (loadedScripts < window.scriptUris.length) {
                    const scriptUri = window.scriptUris[loadedScripts];
                    
                    const script = document.createElement('script');
                    script.src = scriptUri;
                    script.onload = function() {
                        loadedScripts++;
                        setTimeout(loadNextScript, 10); // Small delay to prevent stack overflow
                    };
                    script.onerror = function(error) {
                        console.error('Failed to load script:', scriptUri, error);
                        loadedScripts++;
                        setTimeout(loadNextScript, 10);
                    };
                    document.head.appendChild(script);
                } else {
                    // All scripts loaded, initialize the application
                    if (window.TableEditor && typeof window.TableEditor.init === 'function') {
                        try {
                            window.TableEditor.init();
                        } catch (error) {
                            console.error('Error initializing TableEditor:', error);
                        }
                    } else {
                        console.error('TableEditor object not found in window');
                    }
                }
            } else {
                console.error('No script URIs provided by webview manager');
            }
        }
        
        // Start loading scripts when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for script URIs to be injected
            setTimeout(() => {
                if (window.scriptUris) {
                    loadNextScript();
                } else {
                    // Keep checking for script URIs with timeout
                    let retryCount = 0;
                    const maxRetries = 50; // 5 seconds total
                    const checkInterval = setInterval(() => {
                        retryCount++;
                        if (window.scriptUris) {
                            clearInterval(checkInterval);
                            loadNextScript();
                        } else if (retryCount >= maxRetries) {
                            console.error('Script URIs never became available');
                            clearInterval(checkInterval);
                        }
                    }, 100);
                }
            }, 50);
        });
    </script>
</head>
<body>
    <div id="app">
        <!-- Table tabs and content will be dynamically populated -->
    </div>
    
    <!-- Main table container (dynamically populated) -->
    <div id="table-container"></div>
    
    <!-- Sort Actions Panel -->
    <div class="sort-actions" id="sortActions" style="display: none;">
        <span class="sort-status-badge">ğŸ“Š Viewing sorted data</span>
        <button class="sort-action-btn secondary" onclick="TableEditor.callModule('SortingManager', 'restoreOriginalView')">ğŸ“„ Restore Original</button>
        <button class="sort-action-btn" onclick="TableEditor.callModule('SortingManager', 'commitSortToFile')">ğŸ’¾ Save Sort to File</button>
    </div>
    
    <!-- Context Menus -->
    <div class="context-menu" id="rowContextMenu" style="display: none;">
        <button class="context-menu-item" onclick="TableEditor.callModule('ContextMenuManager', 'addRowAbove')">
            <span class="context-menu-item-icon">â¬†ï¸</span>
            ã“ã®ä¸Šã«è¡Œã‚’è¿½åŠ 
        </button>
        <button class="context-menu-item" onclick="TableEditor.callModule('ContextMenuManager', 'addRowBelow')">
            <span class="context-menu-item-icon">â¬‡ï¸</span>
            ã“ã®ä¸‹ã«è¡Œã‚’è¿½åŠ 
        </button>
        <div class="context-menu-separator"></div>
        <button class="context-menu-item" onclick="TableEditor.callModule('ContextMenuManager', 'deleteRowFromContext')">
            <span class="context-menu-item-icon">ğŸ—‘ï¸</span>
            ã“ã®è¡Œã‚’å‰Šé™¤
        </button>
    </div>
    
    <div class="context-menu" id="columnContextMenu" style="display: none;">
        <button class="context-menu-item" onclick="TableEditor.callModule('ContextMenuManager', 'addColumnLeft')">
            <span class="context-menu-item-icon">â¬…ï¸</span>
            ã“ã®å·¦ã«åˆ—ã‚’è¿½åŠ 
        </button>
        <button class="context-menu-item" onclick="TableEditor.callModule('ContextMenuManager', 'addColumnRight')">
            <span class="context-menu-item-icon">â¡ï¸</span>
            ã“ã®å³ã«åˆ—ã‚’è¿½åŠ 
        </button>
        <div class="context-menu-separator"></div>
        <button class="context-menu-item" onclick="TableEditor.callModule('ContextMenuManager', 'deleteColumnFromContext')">
            <span class="context-menu-item-icon">ğŸ—‘ï¸</span>
            ã“ã®åˆ—ã‚’å‰Šé™¤
        </button>
    </div>
</body>
</html>
