<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
    <title>Markdown Table Editor</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 20px;
        }

        .table-container {
            overflow: auto;
            border: 2px solid var(--vscode-panel-border);
            border-radius: 6px;
            background-color: var(--vscode-editor-background);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .table-editor {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            min-width: 600px;
            font-family: var(--vscode-editor-font-family, 'Consolas', 'Monaco', 'Courier New', monospace);
            font-size: var(--vscode-editor-font-size, 14px);
        }

        /* Column headers */
        .table-editor th {
            background: linear-gradient(180deg, 
                var(--vscode-editor-lineHighlightBackground) 0%, 
                var(--vscode-list-hoverBackground) 100%);
            border: 1px solid var(--vscode-panel-border);
            border-top: 2px solid var(--vscode-focusBorder);
            padding: 10px 12px;
            text-align: left;
            position: relative;
            min-width: 120px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            color: var(--vscode-foreground);
            transition: background-color 0.15s ease;
        }

        .table-editor th:hover {
            background: linear-gradient(180deg, 
                var(--vscode-list-hoverBackground) 0%, 
                var(--vscode-list-activeSelectionBackground) 100%);
        }

        .table-editor th:first-child {
            border-left: 2px solid var(--vscode-focusBorder);
        }

        .table-editor th:last-child {
            border-right: 2px solid var(--vscode-focusBorder);
        }

        /* Row numbers */
        .row-number {
            background: linear-gradient(90deg, 
                var(--vscode-editor-lineHighlightBackground) 0%, 
                var(--vscode-list-hoverBackground) 100%);
            border: 1px solid var(--vscode-panel-border);
            border-left: 2px solid var(--vscode-focusBorder);
            font-weight: 600;
            text-align: center;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            user-select: none;
            color: var(--vscode-descriptionForeground);
            cursor: pointer;
            transition: background-color 0.15s ease;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .row-number:hover {
            background: linear-gradient(90deg, 
                var(--vscode-list-hoverBackground) 0%, 
                var(--vscode-list-activeSelectionBackground) 100%);
            color: var(--vscode-foreground);
        }

        /* Data cells */
        .table-editor td {
            background-color: var(--vscode-editor-background);
            border: 1px solid var(--vscode-panel-border);
            padding: 8px 12px;
            text-align: left;
            position: relative;
            min-width: 120px;
            cursor: cell;
            transition: all 0.15s ease;
            vertical-align: top;
        }

        .table-editor td:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .table-editor td.selected {
            background-color: var(--vscode-list-activeSelectionBackground);
            border: 2px solid var(--vscode-focusBorder);
            box-shadow: inset 0 0 0 1px var(--vscode-focusBorder);
        }

        .table-editor td.editing {
            padding: 0;
            background-color: var(--vscode-input-background);
            border: 2px solid var(--vscode-inputOption-activeBorder);
        }

        /* Grid lines enhancement */
        .table-editor tr:nth-child(even) td:not(.row-number) {
            background-color: var(--vscode-editor-lineHighlightBackground);
        }

        .table-editor tr:nth-child(even) td:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        /* Cell input */
        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 8px 12px;
            font-family: inherit;
            font-size: inherit;
            color: var(--vscode-foreground);
            background-color: var(--vscode-input-background);
            outline: none;
            resize: none;
            box-sizing: border-box;
        }

        .cell-input:focus {
            background-color: var(--vscode-input-background);
            box-shadow: inset 0 0 0 1px var(--vscode-focusBorder);
        }

        /* Column resize handle */
        .resize-handle {
            position: absolute;
            top: 0;
            right: -2px;
            width: 4px;
            height: 100%;
            cursor: col-resize;
            background-color: transparent;
            z-index: 5;
        }

        .resize-handle:hover {
            background-color: var(--vscode-focusBorder);
        }

        /* Selection indicators */
        .column-selected {
            background-color: var(--vscode-list-activeSelectionBackground) !important;
        }

        .row-selected {
            background-color: var(--vscode-list-activeSelectionBackground) !important;
        }

        /* Header corner cell */
        .header-corner {
            background: linear-gradient(135deg, 
                var(--vscode-editor-lineHighlightBackground) 0%, 
                var(--vscode-list-hoverBackground) 100%);
            border: 2px solid var(--vscode-focusBorder);
            border-bottom: 1px solid var(--vscode-panel-border);
            border-right: 1px solid var(--vscode-panel-border);
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            position: sticky;
            left: 0;
            z-index: 20;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            color: var(--vscode-descriptionForeground);
        }

        .header-corner:hover {
            background: linear-gradient(135deg, 
                var(--vscode-list-hoverBackground) 0%, 
                var(--vscode-list-activeSelectionBackground) 100%);
            color: var(--vscode-foreground);
        }

        /* Enhanced column headers */
        .column-header {
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .column-letter {
            font-size: 10px;
            color: var(--vscode-descriptionForeground);
            font-weight: 400;
            text-transform: uppercase;
        }

        .header-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--vscode-foreground);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Enhanced data cells */
        .data-cell {
            position: relative;
        }

        .cell-content {
            min-height: 20px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .empty-cell {
            color: var(--vscode-descriptionForeground);
            font-style: italic;
        }

        .empty-cell .cell-content:empty::before {
            content: "Empty";
            opacity: 0.5;
        }

        /* Selection enhancements */
        .data-cell.selected {
            background-color: var(--vscode-list-activeSelectionBackground) !important;
            color: var(--vscode-list-activeSelectionForeground);
            border: 2px solid var(--vscode-focusBorder) !important;
            box-shadow: inset 0 0 0 1px var(--vscode-focusBorder);
        }

        .row-number.selected,
        .column-header.selected {
            background: var(--vscode-list-activeSelectionBackground) !important;
            color: var(--vscode-list-activeSelectionForeground);
        }

        /* Grid enhancements */
        .table-editor tbody tr:hover {
            background-color: var(--vscode-list-hoverBackground);
        }

        .table-editor tbody tr:hover .row-number {
            background: linear-gradient(90deg, 
                var(--vscode-list-hoverBackground) 0%, 
                var(--vscode-list-activeSelectionBackground) 100%);
        }

        /* Resize cursor */
        .table-editor th {
            position: relative;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            right: -2px;
            width: 4px;
            height: 100%;
            cursor: col-resize;
            background-color: transparent;
            z-index: 5;
        }

        .resize-handle:hover {
            background-color: var(--vscode-focusBorder);
        }

        /* Toolbar enhancements */
        .toolbar {
            margin-bottom: 16px;
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            background-color: var(--vscode-editor-lineHighlightBackground);
            border-radius: 4px;
            border: 1px solid var(--vscode-panel-border);
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background-color: var(--vscode-panel-border);
            margin: 0 8px;
        }

        /* Status bar enhancements */
        .status-bar {
            margin-top: 16px;
            padding: 8px 12px;
            background-color: var(--vscode-statusBar-background);
            color: var(--vscode-statusBar-foreground);
            font-size: 12px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-info {
            display: flex;
            gap: 16px;
        }

        .status-selection {
            color: var(--vscode-statusBar-prominentForeground);
            font-weight: 500;
        }

        .sort-indicator {
            margin-left: 8px;
            font-size: 12px;
        }

        .sort-asc::after {
            content: "‚ñ≤";
        }

        .sort-desc::after {
            content: "‚ñº";
        }

        .toolbar {
            margin-bottom: 16px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 6px 12px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-bar {
            margin-top: 16px;
            padding: 8px;
            background-color: var(--vscode-statusBar-background);
            color: var(--vscode-statusBar-foreground);
            font-size: 12px;
            border-radius: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .save-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-indicator {
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
        }

        .save-indicator.saved {
            background-color: var(--vscode-statusBarItem-prominentBackground);
            color: var(--vscode-statusBarItem-prominentForeground);
        }

        .save-indicator.saving {
            background-color: var(--vscode-statusBarItem-warningBackground);
            color: var(--vscode-statusBarItem-warningForeground);
        }

        .save-indicator.error {
            background-color: var(--vscode-statusBarItem-errorBackground);
            color: var(--vscode-statusBarItem-errorForeground);
        }

        .btn.save-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .btn.save-btn:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--vscode-descriptionForeground);
        }

        .error {
            color: var(--vscode-errorForeground);
            background-color: var(--vscode-inputValidation-errorBackground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        /* Drag and Drop styles */
        .dragging {
            opacity: 0.5 !important;
            transform: rotate(2deg);
            transition: all 0.2s ease;
        }

        .drag-over {
            background-color: var(--vscode-list-dropBackground) !important;
            border: 2px solid var(--vscode-focusBorder) !important;
        }

        .drop-indicator {
            position: absolute;
            background-color: var(--vscode-focusBorder);
            z-index: 1000;
            pointer-events: none;
            opacity: 0.8;
            transition: all 0.2s ease;
            box-shadow: 0 0 6px rgba(0, 122, 255, 0.5);
        }

        .row-number[draggable="true"]:hover {
            cursor: grab;
        }

        .row-number[draggable="true"]:active {
            cursor: grabbing;
        }

        .column-header[draggable="true"]:hover {
            cursor: grab;
        }

        .column-header[draggable="true"]:active {
            cursor: grabbing;
        }

        /* Visual feedback for drag operations */
        .table-editor.drag-active {
            user-select: none;
        }

        .table-editor.drag-active .row-number:not(.dragging) {
            border: 2px dashed var(--vscode-panel-border);
        }

        .table-editor.drag-active .column-header:not(.dragging) {
            border: 2px dashed var(--vscode-panel-border);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">Loading table data...</div>
    </div>

    <script>
        // Global state
        let tableData = null;
        let currentEditingCell = null;
        let sortState = { column: -1, direction: 'none' };

        // VSCode API
        const vscode = acquireVsCodeApi();

        // Initialize the table editor
        function initializeTableEditor() {
            console.log('Table editor initialized');
            
            // Request initial table data
            vscode.postMessage({
                command: 'requestTableData'
            });
        }

        // Render the table
        function renderTable(data) {
            if (!data) {
                document.getElementById('app').innerHTML = '<div class="error">No table data available</div>';
                return;
            }

            tableData = data;
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="toolbar">
                    <button class="btn" onclick="addRow()">Add Row</button>
                    <button class="btn" onclick="addColumn()">Add Column</button>
                    <button class="btn" onclick="deleteSelectedRow()" id="deleteRowBtn" disabled>Delete Row</button>
                    <button class="btn" onclick="deleteSelectedColumn()" id="deleteColBtn" disabled>Delete Column</button>
                    <div class="toolbar-separator"></div>
                    <button class="btn save-btn" onclick="saveTable()" id="saveBtn">üíæ Save</button>
                    <button class="btn" onclick="exportTable()">üì§ Export</button>
                </div>
                
                <div class="table-container">
                    <table class="table-editor" id="tableEditor">
                        ${renderTableContent()}
                    </table>
                </div>
                
                <div class="status-bar">
                    <span>Rows: ${data.rows.length} | Columns: ${data.headers.length}</span>
                    <div class="save-status">
                        <span class="save-indicator saved" id="saveIndicator">‚úì Auto-saved</span>
                    </div>
                </div>
            `;

            setupTableEvents();
        }

        // Render table content
        function renderTableContent() {
            if (!tableData) return '';

            let html = '<thead><tr>';
            
            // Header corner cell (select all)
            html += '<th class="header-corner" onclick="selectAll()" title="Select All">‚öè</th>';
            
            // Column headers with enhanced styling
            tableData.headers.forEach((header, index) => {
                const sortClass = sortState.column === index ? `sort-${sortState.direction}` : '';
                const columnLetter = getColumnLetter(index);
                html += `<th onclick="sortByColumn(${index})" 
                           onmousedown="startColumnSelect(${index})"
                           class="column-header ${sortClass}" 
                           data-col="${index}"
                           title="Column ${columnLetter}: ${escapeHtml(header)}">
                    <div class="header-content">
                        <span class="column-letter">${columnLetter}</span>
                        <span class="header-text">${escapeHtml(header)}</span>
                        <span class="sort-indicator"></span>
                    </div>
                    <div class="resize-handle" onmousedown="startColumnResize(event, ${index})"></div>
                </th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            // Data rows with enhanced styling
            tableData.rows.forEach((row, rowIndex) => {
                html += `<tr data-row="${rowIndex}">`;
                
                // Row number with selection capability
                html += `<td class="row-number" 
                           onclick="selectRow(${rowIndex})" 
                           onmousedown="startRowSelect(${rowIndex})"
                           title="Row ${rowIndex + 1}">
                    ${rowIndex + 1}
                </td>`;
                
                // Data cells with enhanced interaction
                row.forEach((cell, colIndex) => {
                    const cellId = `cell-${rowIndex}-${colIndex}`;
                    const isEmpty = !cell || cell.trim() === '';
                    const cellClass = isEmpty ? 'empty-cell' : '';
                    
                    html += `<td id="${cellId}"
                               class="data-cell ${cellClass}" 
                               onclick="selectCell(${rowIndex}, ${colIndex})" 
                               ondblclick="startCellEdit(${rowIndex}, ${colIndex})"
                               onmousedown="startCellSelect(${rowIndex}, ${colIndex})"
                               data-row="${rowIndex}" 
                               data-col="${colIndex}"
                               title="Cell ${getColumnLetter(colIndex)}${rowIndex + 1}">
                        <div class="cell-content">${escapeHtml(cell)}</div>
                    </td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            return html;
        }

        // Get Excel-style column letter (A, B, C, ..., Z, AA, AB, ...)
        function getColumnLetter(index) {
            let result = '';
            while (index >= 0) {
                result = String.fromCharCode(65 + (index % 26)) + result;
                index = Math.floor(index / 26) - 1;
            }
            return result;
        }

        // Enhanced cell selection system
        let selectedCells = new Set();
        let selectionStart = null;
        let isSelecting = false;

        function selectCell(row, col) {
            clearSelection();
            selectedCells.add(`${row}-${col}`);
            selectionStart = { row, col };
            updateCellSelection();
        }

        function selectRow(rowIndex) {
            clearSelection();
            for (let col = 0; col < tableData.headers.length; col++) {
                selectedCells.add(`${rowIndex}-${col}`);
            }
            updateCellSelection();
        }

        function selectColumn(colIndex) {
            clearSelection();
            for (let row = 0; row < tableData.rows.length; row++) {
                selectedCells.add(`${row}-${colIndex}`);
            }
            updateCellSelection();
        }

        function selectAll() {
            clearSelection();
            for (let row = 0; row < tableData.rows.length; row++) {
                for (let col = 0; col < tableData.headers.length; col++) {
                    selectedCells.add(`${row}-${col}`);
                }
            }
            updateCellSelection();
        }

        function clearSelection() {
            selectedCells.clear();
            document.querySelectorAll('.selected, .row-selected, .column-selected').forEach(el => {
                el.classList.remove('selected', 'row-selected', 'column-selected');
            });
        }

        function updateCellSelection() {
            // Clear previous selection
            document.querySelectorAll('.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Apply new selection
            selectedCells.forEach(cellKey => {
                const [row, col] = cellKey.split('-').map(Number);
                const cell = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
                if (cell) {
                    cell.classList.add('selected');
                }
            });

            // Update toolbar button states
            updateToolbarButtons();
        }

        function updateToolbarButtons() {
            const hasSelection = selectedCells.size > 0;
            const deleteRowBtn = document.getElementById('deleteRowBtn');
            const deleteColBtn = document.getElementById('deleteColBtn');
            
            if (deleteRowBtn) deleteRowBtn.disabled = !hasSelection;
            if (deleteColBtn) deleteColBtn.disabled = !hasSelection;
        }

        // Column resizing functionality
        let isResizing = false;
        let resizeColumn = -1;
        let startX = 0;
        let startWidth = 0;

        function startColumnResize(event, colIndex) {
            event.stopPropagation();
            isResizing = true;
            resizeColumn = colIndex;
            startX = event.clientX;
            
            const header = document.querySelector(`th[data-col="${colIndex}"]`);
            startWidth = header.offsetWidth;
            
            document.addEventListener('mousemove', handleColumnResize);
            document.addEventListener('mouseup', stopColumnResize);
            
            // Prevent text selection during resize
            document.body.style.userSelect = 'none';
        }

        function handleColumnResize(event) {
            if (!isResizing) return;
            
            const deltaX = event.clientX - startX;
            const newWidth = Math.max(60, startWidth + deltaX);
            
            // Apply new width to all cells in the column
            const colCells = document.querySelectorAll(`th[data-col="${resizeColumn}"], td[data-col="${resizeColumn}"]`);
            colCells.forEach(cell => {
                cell.style.width = newWidth + 'px';
                cell.style.minWidth = newWidth + 'px';
            });
        }

        function stopColumnResize() {
            isResizing = false;
            resizeColumn = -1;
            document.removeEventListener('mousemove', handleColumnResize);
            document.removeEventListener('mouseup', stopColumnResize);
            document.body.style.userSelect = '';
        }

        // Setup table event listeners
        function setupTableEvents() {
            // Keyboard navigation
            document.addEventListener('keydown', handleKeyDown);
            
            // Setup drag and drop functionality
            setupDragAndDrop();
        }

        // Handle keyboard navigation
        function handleKeyDown(event) {
            if (currentEditingCell) {
                if (event.key === 'Escape') {
                    cancelCellEdit();
                } else if (event.key === 'Enter') {
                    commitCellEdit();
                    event.preventDefault();
                    // Move to next row after commit
                    if (selectionStart && selectionStart.row < tableData.rows.length - 1) {
                        selectCell(selectionStart.row + 1, selectionStart.col);
                    }
                } else if (event.key === 'Tab') {
                    commitCellEdit();
                    event.preventDefault();
                    // Move to next cell after commit
                    if (selectionStart) {
                        navigateToNextCell(selectionStart.row, selectionStart.col, !event.shiftKey);
                    }
                }
                return;
            }

            // Only handle navigation if we have a selection
            if (!selectionStart || selectedCells.size === 0) {
                return;
            }

            // Arrow key navigation
            switch (event.key) {
                case 'ArrowUp':
                    event.preventDefault();
                    navigateCell(selectionStart.row - 1, selectionStart.col);
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    navigateCell(selectionStart.row + 1, selectionStart.col);
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    navigateCell(selectionStart.row, selectionStart.col - 1);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    navigateCell(selectionStart.row, selectionStart.col + 1);
                    break;
                case 'Tab':
                    event.preventDefault();
                    navigateToNextCell(selectionStart.row, selectionStart.col, !event.shiftKey);
                    break;
                case 'Enter':
                    event.preventDefault();
                    navigateCell(selectionStart.row + 1, selectionStart.col);
                    break;
                case 'Home':
                    event.preventDefault();
                    if (event.ctrlKey || event.metaKey) {
                        // Ctrl+Home: Go to first cell
                        navigateCell(0, 0);
                    } else {
                        // Home: Go to first column of current row
                        navigateCell(selectionStart.row, 0);
                    }
                    break;
                case 'End':
                    event.preventDefault();
                    if (event.ctrlKey || event.metaKey) {
                        // Ctrl+End: Go to last cell
                        navigateCell(tableData.rows.length - 1, tableData.headers.length - 1);
                    } else {
                        // End: Go to last column of current row
                        navigateCell(selectionStart.row, tableData.headers.length - 1);
                    }
                    break;
                case 'PageUp':
                    event.preventDefault();
                    navigateCell(Math.max(0, selectionStart.row - 10), selectionStart.col);
                    break;
                case 'PageDown':
                    event.preventDefault();
                    navigateCell(Math.min(tableData.rows.length - 1, selectionStart.row + 10), selectionStart.col);
                    break;
                case 'F2':
                    event.preventDefault();
                    startCellEdit(selectionStart.row, selectionStart.col);
                    break;
                case 'Delete':
                case 'Backspace':
                    event.preventDefault();
                    // Clear selected cells
                    clearSelectedCells();
                    break;
                case 'Escape':
                    event.preventDefault();
                    clearSelection();
                    break;
                default:
                    // Check for alphanumeric keys to start editing
                    if (event.key.length === 1 && !event.ctrlKey && !event.metaKey && !event.altKey) {
                        startCellEdit(selectionStart.row, selectionStart.col);
                        // Let the character be typed in the input
                        setTimeout(() => {
                            const input = document.querySelector('.cell-input');
                            if (input) {
                                input.value = event.key;
                                input.setSelectionRange(1, 1);
                            }
                        }, 0);
                    }
                    break;
            }
        }

        // Navigate to a specific cell with bounds checking
        function navigateCell(row, col) {
            // Bounds checking
            row = Math.max(0, Math.min(tableData.rows.length - 1, row));
            col = Math.max(0, Math.min(tableData.headers.length - 1, col));
            
            selectCell(row, col);
            scrollToCell(row, col);
        }

        // Navigate to next/previous cell (for Tab navigation)
        function navigateToNextCell(row, col, forward) {
            const totalCols = tableData.headers.length;
            const totalRows = tableData.rows.length;

            if (forward) {
                // Move forward
                col++;
                if (col >= totalCols) {
                    col = 0;
                    row++;
                    if (row >= totalRows) {
                        row = totalRows - 1;
                        col = totalCols - 1;
                    }
                }
            } else {
                // Move backward
                col--;
                if (col < 0) {
                    col = totalCols - 1;
                    row--;
                    if (row < 0) {
                        row = 0;
                        col = 0;
                    }
                }
            }

            navigateCell(row, col);
        }

        // Scroll to ensure cell is visible
        function scrollToCell(row, col) {
            const cell = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
            if (cell) {
                cell.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'nearest'
                });
            }
        }

        // Clear content of selected cells
        function clearSelectedCells() {
            const updates = [];
            selectedCells.forEach(cellKey => {
                const [row, col] = cellKey.split('-').map(Number);
                if (tableData.rows[row] && tableData.rows[row][col] !== undefined) {
                    tableData.rows[row][col] = '';
                    updates.push({ row, col, value: '' });
                }
            });

            // Update UI
            updates.forEach(update => {
                const cell = document.querySelector(`td[data-row="${update.row}"][data-col="${update.col}"]`);
                if (cell) {
                    const content = cell.querySelector('.cell-content');
                    if (content) {
                        content.textContent = '';
                    }
                    cell.classList.add('empty-cell');
                }
            });

            // Send updates to extension
            updates.forEach(update => {
                vscode.postMessage({
                    command: 'updateCell',
                    data: update
                });
            });
        }

        // Start editing a cell
        function startCellEdit(row, col) {
            if (currentEditingCell) {
                commitCellEdit();
            }

            const cell = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
            if (!cell) return;

            currentEditingCell = { row, col, element: cell, originalValue: cell.textContent.trim() };
            
            cell.classList.add('editing');
            cell.innerHTML = `<input type="text" class="cell-input" value="${escapeHtml(currentEditingCell.originalValue)}" />`;
            
            const input = cell.querySelector('.cell-input');
            input.focus();
            input.select();

            input.addEventListener('blur', commitCellEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    commitCellEdit();
                } else if (e.key === 'Escape') {
                    cancelCellEdit();
                }
            });
        }

        // Commit cell edit
        function commitCellEdit() {
            if (!currentEditingCell) return;

            const input = currentEditingCell.element.querySelector('.cell-input');
            const newValue = input ? input.value : currentEditingCell.originalValue;

            // Update local data
            tableData.rows[currentEditingCell.row][currentEditingCell.col] = newValue;

            // Update UI
            currentEditingCell.element.classList.remove('editing');
            currentEditingCell.element.textContent = newValue;

            // Send update to extension
            vscode.postMessage({
                command: 'updateCell',
                data: {
                    row: currentEditingCell.row,
                    col: currentEditingCell.col,
                    value: newValue
                }
            });

            currentEditingCell = null;
        }

        // Cancel cell edit
        function cancelCellEdit() {
            if (!currentEditingCell) return;

            currentEditingCell.element.classList.remove('editing');
            currentEditingCell.element.textContent = currentEditingCell.originalValue;
            currentEditingCell = null;
        }

        // Add row
        function addRow() {
            vscode.postMessage({
                command: 'addRow',
                data: { index: tableData.rows.length }
            });
        }

        // Add column
        function addColumn() {
            const header = prompt('Enter column header:', 'New Column');
            if (header !== null) {
                vscode.postMessage({
                    command: 'addColumn',
                    data: { index: tableData.headers.length, header }
                });
            }
        }

        // Sort by column
        function sortByColumn(columnIndex) {
            let direction = 'asc';
            if (sortState.column === columnIndex) {
                direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            }

            sortState = { column: columnIndex, direction };

            vscode.postMessage({
                command: 'sort',
                data: { column: columnIndex, direction }
            });
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.command) {
                case 'updateTableData':
                    renderTable(message.data);
                    break;
                case 'error':
                    showError(message.message);
                    break;
                case 'success':
                    showSuccess(message.message);
                    break;
                case 'status':
                    showStatus(message.status, message.data);
                    break;
                case 'validationError':
                    showValidationError(message.field, message.message);
                    break;
                case 'ping':
                    // Respond to health check ping
                    vscode.postMessage({
                        command: 'pong',
                        timestamp: message.timestamp,
                        responseTime: Date.now()
                    });
                    break;
            }
        });

        // Show error message
        function showError(message) {
            const app = document.getElementById('app');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = escapeHtml(message);
            
            // Remove existing error messages
            const existingErrors = app.querySelectorAll('.error');
            existingErrors.forEach(error => error.remove());
            
            app.insertBefore(errorDiv, app.firstChild);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const app = document.getElementById('app');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = escapeHtml(message);
            successDiv.style.cssText = `
                color: var(--vscode-notificationsInfoIcon-foreground);
                background-color: var(--vscode-inputValidation-infoBackground);
                border: 1px solid var(--vscode-inputValidation-infoBorder);
                padding: 12px;
                border-radius: 4px;
                margin-bottom: 16px;
            `;
            
            // Remove existing success messages
            const existingSuccess = app.querySelectorAll('.success');
            existingSuccess.forEach(success => success.remove());
            
            app.insertBefore(successDiv, app.firstChild);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }

        // Drag and Drop functionality
        let dragState = {
            isDragging: false,
            dragType: null, // 'row' or 'column'
            dragIndex: -1,
            dragElement: null,
            dropIndicator: null
        };

        // Initialize drag and drop for rows and columns
        function setupDragAndDrop() {
            // Make row numbers draggable
            document.querySelectorAll('.row-number').forEach((rowNum, index) => {
                rowNum.draggable = true;
                rowNum.setAttribute('data-drag-type', 'row');
                rowNum.setAttribute('data-drag-index', index.toString());
            });

            // Make column headers draggable
            document.querySelectorAll('.column-header').forEach((header, index) => {
                header.draggable = true;
                header.setAttribute('data-drag-type', 'column');
                header.setAttribute('data-drag-index', index.toString());
            });

            // Add drag event listeners
            document.addEventListener('dragstart', handleDragStart);
            document.addEventListener('dragover', handleDragOver);
            document.addEventListener('dragenter', handleDragEnter);
            document.addEventListener('dragleave', handleDragLeave);
            document.addEventListener('drop', handleDrop);
            document.addEventListener('dragend', handleDragEnd);
        }

        function handleDragStart(event) {
            const element = event.target;
            const dragType = element.getAttribute('data-drag-type');
            const dragIndex = parseInt(element.getAttribute('data-drag-index'));

            if (!dragType || dragIndex === -1) {
                event.preventDefault();
                return;
            }

            dragState.isDragging = true;
            dragState.dragType = dragType;
            dragState.dragIndex = dragIndex;
            dragState.dragElement = element;

            // Set drag effect
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', '');

            // Add visual feedback
            element.style.opacity = '0.5';
            element.classList.add('dragging');
            
            // Add drag state to table
            const table = document.querySelector('.table-editor');
            if (table) {
                table.classList.add('drag-active');
            }

            // Create drop indicator
            createDropIndicator();

            console.log(`Started dragging ${dragType} ${dragIndex}`);
        }

        function handleDragOver(event) {
            if (!dragState.isDragging) return;

            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';

            const element = event.target.closest(dragState.dragType === 'row' ? '.row-number' : '.column-header');
            if (element) {
                updateDropIndicator(element);
            }
        }

        function handleDragEnter(event) {
            if (!dragState.isDragging) return;
            event.preventDefault();
        }

        function handleDragLeave(event) {
            if (!dragState.isDragging) return;
            // Only hide indicator if we're leaving the table area
            if (!event.relatedTarget || !event.relatedTarget.closest('.table-editor')) {
                hideDropIndicator();
            }
        }

        function handleDrop(event) {
            if (!dragState.isDragging) return;

            event.preventDefault();

            const dropTarget = event.target.closest(dragState.dragType === 'row' ? '.row-number' : '.column-header');
            if (!dropTarget) return;

            const dropIndex = parseInt(dropTarget.getAttribute('data-drag-index'));
            if (dropIndex === -1 || dropIndex === dragState.dragIndex) return;

            console.log(`Dropping ${dragState.dragType} ${dragState.dragIndex} onto ${dropIndex}`);

            // Perform the move operation
            if (dragState.dragType === 'row') {
                moveRowViaDrag(dragState.dragIndex, dropIndex);
            } else if (dragState.dragType === 'column') {
                moveColumnViaDrag(dragState.dragIndex, dropIndex);
            }
        }

        function handleDragEnd(event) {
            if (!dragState.isDragging) return;

            // Clean up visual feedback
            if (dragState.dragElement) {
                dragState.dragElement.style.opacity = '';
                dragState.dragElement.classList.remove('dragging');
            }
            
            // Remove drag state from table
            const table = document.querySelector('.table-editor');
            if (table) {
                table.classList.remove('drag-active');
            }

            hideDropIndicator();

            // Reset drag state
            dragState = {
                isDragging: false,
                dragType: null,
                dragIndex: -1,
                dragElement: null,
                dropIndicator: null
            };
        }

        function createDropIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'drop-indicator';
            indicator.style.cssText = `
                position: absolute;
                background-color: var(--vscode-focusBorder);
                z-index: 1000;
                pointer-events: none;
                opacity: 0.8;
                transition: all 0.2s ease;
            `;

            if (dragState.dragType === 'row') {
                indicator.style.height = '3px';
                indicator.style.left = '0';
                indicator.style.right = '0';
            } else {
                indicator.style.width = '3px';
                indicator.style.top = '0';
                indicator.style.bottom = '0';
            }

            document.body.appendChild(indicator);
            dragState.dropIndicator = indicator;
        }

        function updateDropIndicator(element) {
            if (!dragState.dropIndicator) return;

            const rect = element.getBoundingClientRect();
            const indicator = dragState.dropIndicator;

            if (dragState.dragType === 'row') {
                indicator.style.top = (rect.bottom - 1) + 'px';
                indicator.style.left = rect.left + 'px';
                indicator.style.width = rect.width + 'px';
                indicator.style.display = 'block';
            } else {
                indicator.style.left = (rect.right - 1) + 'px';
                indicator.style.top = rect.top + 'px';
                indicator.style.height = rect.height + 'px';
                indicator.style.display = 'block';
            }
        }

        function hideDropIndicator() {
            if (dragState.dropIndicator) {
                dragState.dropIndicator.style.display = 'none';
            }
        }

        function moveRowViaDrag(fromIndex, toIndex) {
            console.log(`Moving row from ${fromIndex} to ${toIndex}`);
            
            vscode.postMessage({
                command: 'moveRow',
                data: { from: fromIndex, to: toIndex }
            });
        }

        function moveColumnViaDrag(fromIndex, toIndex) {
            console.log(`Moving column from ${fromIndex} to ${toIndex}`);
            
            vscode.postMessage({
                command: 'moveColumn',
                data: { from: fromIndex, to: toIndex }
            });
        }

        // Enhanced render function to include drag and drop setup
        function renderTableWithDragDrop(data) {
            renderTable(data);
            setTimeout(() => {
                setupDragAndDrop();
            }, 100);
        }

        // Show status message
        function showStatus(status, data) {
            const statusBar = document.querySelector('.status-bar');
            if (statusBar) {
                statusBar.textContent = status;
                if (data && tableData) {
                    statusBar.textContent += ` | Rows: ${tableData.rows.length} | Columns: ${tableData.headers.length}`;
                }
            }
        }

        // Show validation error
        function showValidationError(field, message) {
            console.warn(`Validation error for ${field}: ${message}`);
            showError(`Validation error: ${message}`);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeTableEditor);
    </script>
</body>
</html>